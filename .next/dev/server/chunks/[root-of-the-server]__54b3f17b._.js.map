{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/adrianbautista/Desktop/social-monetization-platform%201.20.22%E2%80%AFa.m./lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient()\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["file:///Users/adrianbautista/Desktop/social-monetization-platform%201.20.22%E2%80%AFa.m./app/api/upload/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js'; \nimport { prisma } from \"../../../lib/db\"; // Asegúrate de que la ruta relativa sea correcta\n\n// --- CONFIGURACIÓN DIRECTA (Para evitar problemas de lectura del .env) ---\nconst supabaseUrl = \"https://zlbrduunzxtrkacuifcc.supabase.co\";\n// Asegúrate de que esta clave no tenga espacios ni saltos de línea al copiarla\nconst supabaseServiceKey = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsYnJkdXVuenh0cmthY3VpZmNjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NDUzOTM1MywiZXhwIjoyMDgwMTE1MzUzfQ.-X92j505DEv4AelznTD9lfXagJ1SeFVRA_bj6VuPwW8\";\n\n// Creamos el cliente de Supabase\nconst supabase = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: {\n    persistSession: false,\n    autoRefreshToken: false,\n    detectSessionInUrl: false,\n  },\n});\n\nexport async function POST(req: Request) {\n  try {\n    const formData = await req.formData();\n    const file = formData.get('file') as File | null;\n    const caption = formData.get('caption') as string | null;\n    const email = formData.get('email') as string | null;\n\n    if (!file || !email) {\n      return NextResponse.json({ error: \"Faltan datos (archivo o email)\" }, { status: 400 });\n    }\n\n    // 1. Obtener usuario de la Base de Datos\n    const user = await prisma.user.findUnique({\n        where: { email: email },\n        select: { id: true }\n    });\n\n    if (!user) {\n         return NextResponse.json({ error: \"Usuario no encontrado en la DB\" }, { status: 404 });\n    }\n    \n    // 2. Preparar el archivo\n    const arrayBuffer = await file.arrayBuffer();\n    const buffer = Buffer.from(arrayBuffer);\n    const fileExt = file.name.split('.').pop();\n    // Nombre único para evitar colisiones\n    const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;\n    \n    // 3. SUBIR A SUPABASE\n    const { error: uploadError } = await supabase.storage\n      .from('user-posts')\n      .upload(fileName, buffer, {\n        contentType: file.type || 'application/octet-stream',\n        upsert: false\n      });\n\n    if (uploadError) {\n      console.error('Error Supabase Storage:', uploadError);\n      return NextResponse.json({ error: 'Error al subir imagen a la nube', details: uploadError.message }, { status: 500 });\n    }\n    \n    // 4. Construir la URL pública\n    const publicUrl = `${supabaseUrl}/storage/v1/object/public/user-posts/${fileName}`;\n\n    // 5. Guardar referencia en la Base de Datos (Prisma)\n    // Nos aseguramos de usar los nombres de campos correctos según tu schema.prisma\n    const newPost = await prisma.post.create({\n        data: {\n            videoUrl: publicUrl,\n            caption: caption || '',\n            userId: user.id,\n            isLocked: false, // Asegúrate de que este campo exista en tu schema.prisma como 'isLocked' o cámbialo a 'isExclusive' si es necesario\n        }\n    });\n\n    return NextResponse.json({ success: true, post: newPost });\n\n  } catch (error) {\n    console.error('Error General en API:', error);\n    return NextResponse.json({ error: 'Error interno del servidor' }, { status: 500 });\n  }\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA,2LAA0C,iDAAiD;;;;AAE3F,4EAA4E;AAC5E,MAAM,cAAc;AACpB,+EAA+E;AAC/E,MAAM,qBAAqB;AAE3B,iCAAiC;AACjC,MAAM,WAAW,IAAA,mRAAY,EAAC,aAAa,oBAAoB;IAC7D,MAAM;QACJ,gBAAgB;QAChB,kBAAkB;QAClB,oBAAoB;IACtB;AACF;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,MAAM,UAAU,SAAS,GAAG,CAAC;QAC7B,MAAM,QAAQ,SAAS,GAAG,CAAC;QAE3B,IAAI,CAAC,QAAQ,CAAC,OAAO;YACnB,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiC,GAAG;gBAAE,QAAQ;YAAI;QACtF;QAEA,yCAAyC;QACzC,MAAM,OAAO,MAAM,qHAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YACtC,OAAO;gBAAE,OAAO;YAAM;YACtB,QAAQ;gBAAE,IAAI;YAAK;QACvB;QAEA,IAAI,CAAC,MAAM;YACN,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiC,GAAG;gBAAE,QAAQ;YAAI;QACzF;QAEA,yBAAyB;QACzB,MAAM,cAAc,MAAM,KAAK,WAAW;QAC1C,MAAM,SAAS,OAAO,IAAI,CAAC;QAC3B,MAAM,UAAU,KAAK,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG;QACxC,sCAAsC;QACtC,MAAM,WAAW,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,MAAM,CAAC,GAAG,GAAG,CAAC,EAAE,SAAS;QAEtF,sBAAsB;QACtB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAAS,OAAO,CAClD,IAAI,CAAC,cACL,MAAM,CAAC,UAAU,QAAQ;YACxB,aAAa,KAAK,IAAI,IAAI;YAC1B,QAAQ;QACV;QAEF,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,2BAA2B;YACzC,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAAmC,SAAS,YAAY,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACrH;QAEA,8BAA8B;QAC9B,MAAM,YAAY,GAAG,YAAY,qCAAqC,EAAE,UAAU;QAElF,qDAAqD;QACrD,gFAAgF;QAChF,MAAM,UAAU,MAAM,qHAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YACrC,MAAM;gBACF,UAAU;gBACV,SAAS,WAAW;gBACpB,QAAQ,KAAK,EAAE;gBACf,UAAU;YACd;QACJ;QAEA,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,MAAM;QAAQ;IAE1D,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA6B,GAAG;YAAE,QAAQ;QAAI;IAClF;AACF"}}]
}